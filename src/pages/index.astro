---
import '@/styles/global.css';
import MonoAdvent from '@/components/MonoAdvent.tsx';
import SEO from '@/components/SEO.astro';
import { Font } from 'astro:assets';
import { UNLOCK_ALL_DOORS } from 'astro:env/server';
import { getCollection } from 'astro:content';
import { startOfDayUTC, slugCollator } from '@/utils/dates';

const title = 'Advent of AI Security 2025';
const description = 'A friendly, step-by-step Advent calendar of AI security risks and hands-on examples for practitioners and curious engineers.';
const doorsCollection = await getCollection('doors');
const todayUTC = startOfDayUTC(new Date());

const doors = doorsCollection
  .map((entry) => ({
    slug: entry.slug,
    title: entry.data.title,
    description: entry.data.description,
    date: entry.data.date as Date | undefined,
  }))
  .filter((d): d is { slug: string; title: string; description: string | undefined; date: Date } => {
    return d.date instanceof Date && !Number.isNaN(d.date.getTime());
  })
  .map((d) => {
    const dateMidnight = startOfDayUTC(d.date);
    let state: 'open' | 'today' | 'locked';
    if (UNLOCK_ALL_DOORS) state = 'open';
    else if (dateMidnight < todayUTC) state = 'open';
    else if (dateMidnight.getTime() === todayUTC.getTime()) state = 'today';
    else state = 'locked';
    const base = {
      slug: d.slug,
      title: d.title,
      date: d.date.toISOString(),
      state,
    };
    return d.description !== undefined ? { ...base, description: d.description } : base;
  })
  .sort((a, b) => slugCollator.compare(a.slug, b.slug));
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <Font cssVariable="--font-plex-mono" preload />
    <SEO
      title={title}
      description={description}
      type="website"
      canonicalPath="/"
      image="/favicon.svg"
      siteName="Advent of AI Security"
      jsonLd={{
        '@context': 'https://schema.org',
        '@type': 'WebSite',
        name: 'Advent of AI Security',
        url: new URL('/', Astro.site ?? Astro.url).toString(),
        description,
      }}
    />
  </head>
  <body>
    <MonoAdvent client:only="react" unlockAll={UNLOCK_ALL_DOORS} doors={doors} />
  </body>
</html>
