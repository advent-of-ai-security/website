---
import BaseLayout from '@/layouts/BaseLayout.astro';
import MonoAdvent from '@/components/MonoAdvent.tsx';
import type { DoorDocument, DoorState } from '@/components/MonoAdvent.tsx';
import { UNLOCK_ALL_DOORS } from 'astro:env/server';
import { getCollection } from 'astro:content';
import { startOfDayUTC, slugCollator } from '@/utils/dates';

const siteName = 'Advent of AI Security';
const title = `${siteName} 2025`;
const description = 'A friendly, step-by-step Advent calendar of AI security risks and hands-on examples for practitioners and curious engineers.';
const doorsCollection = await getCollection('doors');
const todayUTC = startOfDayUTC(new Date());

const doors: DoorDocument[] = doorsCollection
  .map((entry) => ({
    slug: entry.slug,
    title: entry.data.title,
    description: entry.data.description,
    date: entry.data.date,
  }))
  .filter((d): d is { slug: string; title: string; description: string | undefined; date: Date } => {
    return d.date instanceof Date && !Number.isNaN(d.date.getTime());
  })
  .sort((a, b) => slugCollator.compare(a.slug, b.slug))
  .map((d, index): DoorDocument => {
    const dateMidnight = startOfDayUTC(d.date);
    let state: DoorState;
    if (UNLOCK_ALL_DOORS) state = 'open';
    else if (dateMidnight < todayUTC) state = 'open';
    else if (dateMidnight.getTime() === todayUTC.getTime()) state = 'today';
    else state = 'locked';
    // Strip sensitive data for locked doors
    const base = {
      slug: state === 'locked' ? String(index + 1).padStart(2, '0') : d.slug,
      title: state === 'locked' ? `Door ${index + 1}` : d.title,
      date: d.date.toISOString(),
      state,
    };
    return (state !== 'locked' && d.description !== undefined) ? { ...base, description: d.description } : base;
  });
---

<BaseLayout
  title={title}
  description={description}
  canonicalPath="/"
  jsonLd={{
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: siteName,
    url: new URL('/', Astro.site ?? Astro.url).toString(),
    description,
  }}
>
  <div id="top"></div>
  <MonoAdvent client:only="react" unlockAll={UNLOCK_ALL_DOORS} doors={doors} />
</BaseLayout>
