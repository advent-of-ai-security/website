---
import BaseLayout from '@/layouts/BaseLayout.astro';
import DoorLayout from '@/layouts/DoorLayout.astro';
import { getCollection } from 'astro:content';
import { UNLOCK_ALL_DOORS } from 'astro:env/server';
import { startOfDayUTC } from '@/utils/dates';

const slugParam = Astro.params.slug;
if (!slugParam) {
  return Astro.redirect('/', 302);
}
const slug = slugParam;
const entries = await getCollection('doors');
const entry = entries.find((e) => e.slug === slug);

if (!entry) {
  return Astro.redirect('/', 302);
}

const todayUTC = startOfDayUTC(new Date());
const dateObj = entry.data.date;
const isFuture = dateObj instanceof Date && startOfDayUTC(dateObj) > todayUTC;

if (!UNLOCK_ALL_DOORS && isFuture) {
  return Astro.redirect('/', 302);
}

const { Content } = await entry.render();
const { data } = entry;

const siteName = 'Advent of AI Security';
---

<BaseLayout
  title={data.title}
  {...(data.description !== undefined ? { description: data.description } : {})}
  canonicalPath={`/doors/${slug}`}
  type="article"
  {...(dateObj instanceof Date ? { publishedTime: dateObj.toISOString() } : {})}
  jsonLd={{
    '@context': 'https://schema.org',
    '@type': 'Article',
    headline: data.title,
    ...(data.description !== undefined ? { description: data.description } : {}),
    datePublished: dateObj instanceof Date ? dateObj.toISOString() : undefined,
    mainEntityOfPage: new URL(`/doors/${slug}`, Astro.site ?? Astro.url).toString(),
    publisher: {
      '@type': 'Organization',
      name: siteName
    }
  }}
>
  <DoorLayout
    title={data.title}
    meta={data.meta ?? []}
  >
    <Content />
  </DoorLayout>
</BaseLayout>
